<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>Top5 Voter</title>
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
		<link rel="stylesheet" type="text/css" href="css/style.css">
	</head>
	<body>
		<div class="wrap">
			<div id="app"></div>
		</div>

		<!-- React JS -->
		<script src="https://fb.me/react-0.13.3.js"></script>
		<script src="https://fb.me/JSXTransformer-0.13.3.js"></script>

		<script src="https://npmcdn.com/react-router/umd/ReactRouter.min.js"></script>

		<!-- Firebase -->
		<script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
		<script type="text/jsx">

			var TrackItem = React.createClass({
				render: function () {
					return (
						<li className="track">
							<img src={ this.props.track.art } alt={ this.props.track.track } />
							<div className="track-content">
								<h4 className="track-title"><a href={ this.props.track.link } target="_blank">{ this.props.track.track }</a></h4>
								<h5 className="track-artist">{ this.props.track.artist }</h5>
								<p><small>Added by <span>{ this.props.track.user }</span> on <span>{ this.props.track.added }</span></small></p>
								<button 
									className={ this.props.track.localLiked ? 'liked' : '' }
									onClick={ this.props.addLike.bind(null, this.props.track['.key']) }>
									<i className="fa fa-heart"></i>{ this.props.track.likes > 0 ? ' ' + this.props.track.likes : ''  }
								</button>
							</div>
						</li>
					);
				}
			});

			var TrackList = React.createClass({
				getInitialState: function () {
					return {
						tracks: []
					}
				},

				componentWillMount: function () {
					var addTracksToList = function(snapshot) {
						var items = [];

						snapshot.forEach(function(childSnapshot) {
							var item = childSnapshot.val();

							var key = childSnapshot.key();
							
							item['.key'] = key;

							item['localLiked'] = localStorage.getItem(key) ? true : false;

					        items.push(item);
						}.bind(this));

						items.reverse();

						this.setState({
							tracks: items
						});
					};

					this.firebaseRef = new Firebase('https://top5voter.firebaseio.com/tracks');

					if (this.props.type == 'recent') {
						this.firebaseRef.limitToLast(20).on('value', addTracksToList.bind(this));	
					}

					if (this.props.type == 'popular') {
						this.firebaseRef.orderByChild("likes").limitToLast(20).on('value', addTracksToList.bind(this));	
					}
					
				},

				componentWillUnmount: function() {
					this.firebaseRef.off();
				},

				toggleLike: function (key) {

					siteLikesRef = this.firebaseRef.child(key + '/likes');
					siteLikesRef.transaction(function (current_value) {
						var likes = current_value || 0;

						var localLiked = localStorage.getItem(key) ? true : false;

						if (localLiked) {
							likes--;
							localStorage.removeItem(key);
						} else {
							likes++;
							localStorage.setItem(key, true);
						}
						

						return likes;
					});
				},

				render: function () {
					var _this = this;
					var createTrack = function (track, index) {
						return (
							<TrackItem 
								key={ index }
								track = { track }
								addLike={ _this.toggleLike }
							/>
						);
					}
					return <ul className="tracklist">{ this.state.tracks.map(createTrack) }</ul>;
				}
			});

			function buildTrackList (type) {
				return React.createClass({
					render: function () {
						return (<TrackList {...this.props} type={type} />)
					}
				});
			}

			var Popular = buildTrackList('popular');
			var Recent = buildTrackList('recent');

			var App = React.createClass({
				render: function () {
					return (
						<div>
							<h1 className="app-title">Top 5 Voter</h1>
							<ul className="nav">
								<li><Link to="/recent" activeClassName="active">Recent</Link></li>
								<li><Link to="/popular" activeClassName="active">Popular</Link></li>
							</ul>
							{ this.props.children }
						</div>
					);
				}
			});

			var Router = window.ReactRouter.Router;
			var Route = window.ReactRouter.Route;
			var IndexRoute = window.ReactRouter.IndexRoute;
			var Link = window.ReactRouter.Link;

			React.render((
				<Router>
					<Route path="/" component={App}>
						<IndexRoute component={Recent} />
						<Route path="recent" component={Recent} />
						<Route path="popular" component={Popular} />
					</Route>
				</Router>
			), document.getElementById('app'));
		</script>
	</body>
</html>